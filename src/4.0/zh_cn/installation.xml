<?xml version="1.0" encoding="utf-8" ?>

<chapter id="installation">
  <title>安装 PHPUnit</title>

  <note>
    <para>
      PHPUnit 4.0 需要 PHP 5.3.3，强烈推荐使用最新版本的 PHP。
    </para>

     <para>
     如果需要支持代码覆盖率分析，需要 <ulink url="http://xdebug.org/">Xdebug</ulink> 2.1.3，强烈推荐使用最新版本的 Xdebug。
    </para>
  </note>

  <section id="installation.phar">
    <title>PHP档案包(PHAR)</title>

    <para>
      要获取 PHPUnit，最简单的方法是下载 PHPUnit 的 <ulink
      url="http://php.net/phar">PHP 档案包(PHAR)</ulink>，它将 PHPUnit 所需要的所有必要组件（以及某些可选组件）捆绑在单个文件中：
    </para>

    <screen><userinput>wget https://phar.phpunit.de/phpunit.phar</userinput> 
<userinput>chmod +x phpunit.phar</userinput>
<userinput>mv phpunit.phar /usr/local/bin/phpunit</userinput></screen>

    <para>
      当然，也可以下载后直接使用这个 PHAR：
    </para>

    <screen><userinput>wget https://phar.phpunit.de/phpunit.phar</userinput>
<userinput>php phpunit.phar</userinput></screen>
  </section>

  <section id="installation.composer">
    <title>Composer</title>

    <para>
      如果用 <ulink url="http://getcomposer.org/">Composer</ulink> 来管理项目的依赖关系，只要在项目的 <filename>composer.json</filename> 文件中简单地加上对 <literal>phpunit/phpunit</literal> 的依赖关系即可。下面是一个最小化的 <filename>composer.json</filename> 文件的例子，只定义了一个对 PHPUnit 4.0 的开发时(development-time)依赖：
    </para>

    <programlisting><![CDATA[{
    "require-dev": {
        "phpunit/phpunit": "4.0.*"
    }
}]]></programlisting>

    <para>
      要通过 Composer 完成系统级的安装，可以运行：
    </para>

    <screen><userinput>composer global require 'phpunit/phpunit=4.0.*'</userinput></screen>

    <para>
      请确保 path 变量中包含有 <literal>~/.composer/vendor/bin/</literal>。
    </para>
  </section>

  <section id="installation.optional-packages">
    <title>可选的组件包</title>

    <para>
      有以下可选组件包可用：
    </para>

    <variablelist>
      <varlistentry>
        <term>
          <literal>PHP_Invoker</literal>
        </term>
        <listitem>
          <para>
            一个工具类，可以用带有超时限制的方式调用可调用内容。当需要在严格模式下保证测试的超时限制时，这个组件包是必须的。
          </para>

          <para>
            PHPUnit 的 PHAR 分发中已经包含了此组件包。若要通过 Composer 安装此组件包，添加如下 <literal>"require-dev"</literal> 依赖项：
          </para>

          <screen><userinput>"phpunit/php-invoker": "*"</userinput></screen>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term>
          <literal>DbUnit</literal>
        </term>
        <listitem>
          <para>
            移植到 PHP/PHPUnit 上的 DbUnit 用于提供对数据库交互测试的支持。
          </para>

          <para>
            PHPUnit 的 PHAR 分发中已经包含了此组件包。若要通过 Composer 安装此组件包，添加如下 <literal>"require-dev"</literal> 依赖项：
          </para>

          <screen><userinput>"phpunit/dbunit": ">=1.2"</userinput></screen>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term>
          <literal>PHPUnit_Selenium</literal>
        </term>
        <listitem>
          <para>
            将 Selenium RC 集成于 PHPUnit。
          </para>

          <para>
            PHPUnit 的 PHAR 分发中已经包含了此组件包。若要通过 Composer 安装此组件包，添加如下 <literal>"require-dev"</literal> 依赖项：
          </para>

          <screen><userinput>"phpunit/phpunit-selenium": ">=1.2"</userinput></screen>
        </listitem>
      </varlistentry>
    </variablelist>
  </section>

  <section id="installing.upgrading">
    <title>升级</title>

    <para>
      此部分收集了从 PHPUnit 3.7 升级到 PHPUnit 4.0 时可能遭遇的一些小的向后兼容问题。
    </para>

    <para>
      升级应当是十分简单且不会遭遇任何问题的，因为这个过程已经针对所有主要的开源框架进行过测试并且不存在任何问题。但是每个项目毕竟是各有不同的，如果你已经尝试了某个候选发布版本并且遭遇到了问题，本文档也许能提供一些帮助。
    </para>

    <itemizedlist>
      <listitem>
        <para>
          The limited support for <ulink
          url="http://sebastian-bergmann.de/blog/883-Stubbing-and-Mocking-Static-Methods.html">stubbing
          and mocking static methods</ulink> that was introduced in PHPUnit 3.5
          has been removed. This feature only worked when the stubbed or mocked
          static method was invoked from another method of the same class. We
          believe that the limited use of this feature did not justify the
          increased complexity in the test doubles code generator it incurred.
          We apologize for any inconvenience this removal may cause and
          encourage refactoring the code under test to not require this feature
          for testing.
        </para>
      </listitem>

      <listitem>
        <para>
          The <code>addRiskyTest()</code> was added to the
          <code>PHPUnit_Framework_TestListener</code> interface. Classes that
          implement this interface have to implement this new method. This is
          the reason why PHPStorm 7 is not compatible with PHPUnit 4, for
          instance.
        </para>
      </listitem>

      <listitem>
        <para>
          The fixes for <ulink url="https://github.com/sebastianbergmann/phpunit/issues/552">#552</ulink>,
          <ulink url="https://github.com/sebastianbergmann/phpunit/issues/573">#573</ulink>,
          and <ulink url="https://github.com/sebastianbergmann/phpunit/issues/582">#582</ulink>
          required a change to how relative paths are resolved for PHPUnit's XML
          configuration file. All relative paths in a configuration file are now
          resolved relative to that configuration file. When upgrading, you may
          need to update relative paths for the following configurations
          <code>testSuiteLoaderFile</code>, <code>printerFile</code>,
          <code>testsuites/file</code>, and <code>testsuites/exclude</code>.
        </para>
      </listitem>

      <listitem>
        <para>
          <ulink url="https://github.com/sebastianbergmann/phpunit/commit/f5df97cda0b25f2b7368395344da095ac529de62">The
          numeric comparator is no longer invoked when provided with two
          strings</ulink>.
        </para>
      </listitem>
    </itemizedlist>

    <para>
      Please note that starting with PHPUnit 4.0.0 the PEAR package of PHPUnit
      is merely a distribution mechanism for the PHP Archive (PHAR) and that
      many of PHPUnit's dependencies will no longer be released individually via
      PEAR. We will eventually stop making releases of PHPUnit available via
      PEAR altogether.
    </para>

    <para>
      Please note that using the PEAR installer to update from PHPUnit 3.7 to
      PHPUnit 4.0 will leave stale source files from previous versions of
      PHPUnit's dependencies (PHP_CodeCoverage, PHPUnit_MockObject, ...) behind
      in your PHP environment's PEAR directory. It is advised to uninstall the
      respective PEAR packages.
    </para>
  </section>
</chapter>
